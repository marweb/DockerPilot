# DockPilot - Production Docker Compose (pre-built images from ghcr.io)
#
# This file is used by the install.sh and upgrade.sh scripts.
# Images are pulled from ghcr.io/marweb/dockpilot-*
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Environment variables are loaded from .env in the same directory.

services:
  api-gateway:
    image: ghcr.io/marweb/dockpilot-api-gateway:${DOCKPILOT_VERSION:-latest}
    container_name: dockpilot-api-gateway
    restart: unless-stopped
    ports:
      - '${API_GATEWAY_PORT:-3000}:3000'
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-15m}
      - REFRESH_TOKEN_EXPIRES_IN=${REFRESH_TOKEN_EXPIRES_IN:-7d}
      - DOCKER_CONTROL_URL=${DOCKER_CONTROL_URL:-http://docker-control:3001}
      - TUNNEL_CONTROL_URL=${TUNNEL_CONTROL_URL:-http://tunnel-control:3002}
      - DATA_DIR=/data
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-1 minute}
      - DOCKPILOT_VERSION=${DOCKPILOT_VERSION:-latest}
      - MASTER_KEY=${MASTER_KEY}
    volumes:
      - api-gateway-data:/data
    networks:
      - dockpilot-network
    healthcheck:
      test: ['CMD', 'curl', '-sf', 'http://127.0.0.1:3000/healthz']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      docker-control:
        condition: service_healthy
      tunnel-control:
        condition: service_healthy
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  docker-control:
    image: ghcr.io/marweb/dockpilot-docker-control:${DOCKPILOT_VERSION:-latest}
    container_name: dockpilot-docker-control
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - DOCKER_HOST=${DOCKER_HOST:-unix:///var/run/docker.sock}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - COMPOSE_DIR=/data/compose
      - DOCKPILOT_VERSION=${DOCKPILOT_VERSION:-latest}
      - DOCKPILOT_SOURCE_DIR=${DOCKPILOT_HOME:-/data/dockpilot}/source
      - MASTER_KEY=${MASTER_KEY}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
    volumes:
      - docker-control-data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - dockpilot-network
    healthcheck:
      test: ['CMD', 'curl', '-sf', 'http://127.0.0.1:3001/healthz']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    privileged: true
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  tunnel-control:
    image: ghcr.io/marweb/dockpilot-tunnel-control:${DOCKPILOT_VERSION:-latest}
    container_name: dockpilot-tunnel-control
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3002
      - HOST=0.0.0.0
      - CLOUDFLARED_PATH=${CLOUDFLARED_PATH:-/usr/local/bin/cloudflared}
      - CREDENTIALS_DIR=${CREDENTIALS_DIR:-/data/tunnels}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - tunnel-control-data:/data
    dns:
      - 1.1.1.1
      - 1.0.0.1
    networks:
      - dockpilot-network
    healthcheck:
      test: ['CMD', 'curl', '-sf', 'http://127.0.0.1:3002/healthz']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  web:
    image: ghcr.io/marweb/dockpilot-web:${DOCKPILOT_VERSION:-latest}
    container_name: dockpilot-web
    restart: unless-stopped
    ports:
      - '${WEB_PORT:-8000}:80'
    environment:
      - NODE_ENV=production
    networks:
      - dockpilot-network
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'wget --spider -q http://127.0.0.1:80/ || exit 1']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

volumes:
  api-gateway-data:
    driver: local
  docker-control-data:
    driver: local
  tunnel-control-data:
    driver: local

networks:
  dockpilot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
